<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Traceability Graph</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #0f1724; color: #cdd6f4; }
  .topbar { background: #1a2332; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #2a3a52; flex-shrink: 0; }
  .topbar h1 { margin: 0; font-size: 16px; color: #cdd6f4; font-weight: 600; }
  .topbar .meta { font-size: 12px; color: #6b7a99; }
  .layout { display: flex; flex: 1; overflow: hidden; }
  #graph { flex: 1; }
  .sidebar { width: 300px; background: #1a2332; border-left: 1px solid #2a3a52; padding: 16px; overflow-y: auto; flex-shrink: 0; }
  .sidebar h2 { font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7a99; margin: 16px 0 8px 0; }
  .sidebar h2:first-child { margin-top: 0; }
  .sidebar .issue-list { list-style: none; padding: 0; margin: 0; }
  .sidebar .issue-list li { font-size: 12px; padding: 4px 8px; background: #0f1724; border-radius: 4px; margin-bottom: 4px; color: #cdd6f4; }
  .sidebar .issue-list li span { font-size: 10px; display: block; color: #6b7a99; }
  .badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-bottom: 6px; }
  .badge.l1 { background: #1d4e7e; color: #5dade2; }
  .badge.l2 { background: #1a4731; color: #52be80; }
  .badge.issue { background: #7b1e1e; color: #f1948a; }
  .badge.ok { background: #1a4731; color: #52be80; }
  .legend { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 8px; }
  .legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #8a9bb0; }
  .legend-dot { width: 10px; height: 10px; border-radius: 2px; }
  .tooltip { position: absolute; background: #1a2332; border: 1px solid #2a3a52; padding: 10px 14px; border-radius: 6px; font-size: 12px; pointer-events: none; display: none; max-width: 240px; line-height: 1.5; color: #cdd6f4; z-index: 100; }
  .stats { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .stat { background: #0f1724; border-radius: 6px; padding: 8px 12px; flex: 1; min-width: 60px; text-align: center; }
  .stat .v { font-size: 22px; font-weight: 700; }
  .stat .l { font-size: 10px; color: #6b7a99; text-transform: uppercase; }
  .empty { color: #4a5568; font-size: 12px; font-style: italic; padding: 4px 0; }
  svg text { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
</style>
</head>
<body>
<div class="topbar">
  <h1>â¬¡ Requirements Traceability Graph</h1>
  <span class="meta">pii_anonymizer_requirements_v2.json Â· 2026-02-26T12:50:37.036016+00:00Z</span>
</div>
<div class="layout">
<svg id="graph"></svg>
<div class="sidebar">
  <div class="stats" id="stats"></div>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#2980b9"></div>L1 System Req</div>
    <div class="legend-item"><div class="legend-dot" style="background:#27ae60;border-radius:50%"></div>L2 Subsystem Req</div>
    <div class="legend-item"><div class="legend-dot" style="background:#e74c3c;border-radius:50%"></div>Untested</div>
  </div>

  <h2>ðŸ”´ Orphan Requirements</h2>
  <ul class="issue-list" id="orphan-list"></ul>

  <h2>ðŸŸ¡ Childless L1 Requirements</h2>
  <ul class="issue-list" id="childless-list"></ul>

  <h2>âš« Untested Requirements</h2>
  <ul class="issue-list" id="untested-list"></ul>

  <h2>ðŸ”— Broken Links</h2>
  <ul class="issue-list" id="broken-list"></ul>
</div>
</div>
<div class="tooltip" id="tooltip"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>
const nodes = [{"id": "SYS-001", "title": "Anonymize PII in submitted text via HTTPS", "level": "L1", "status": "Draft", "interface": "IF-HTTPS-API", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SYS-002", "title": "Restore placeholders to originals via HTTPS", "level": "L1", "status": "Draft", "interface": "IF-HTTPS-API", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SYS-003", "title": "Reject unauthenticated API requests", "level": "L1", "status": "Draft", "interface": "IF-HTTPS-API", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SYS-004", "title": "Enforce HTTPS-only transport for all API traffic", "level": "L1", "status": "Draft", "interface": "IF-TLS", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SUB-DAT-004", "title": "Persist session mappings across service restarts", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-DAT-005", "title": "Expire and purge sessions after configurable TTL", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SYS-007", "title": "Anonymize and restore text via CLI", "level": "L1", "status": "Draft", "interface": "IF-CLI", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SYS-008", "title": "Expose session inspection and reset via CLI", "level": "L1", "status": "Draft", "interface": "IF-CLI", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SYS-009", "title": "Expose health status via admin endpoint", "level": "L1", "status": "Draft", "interface": "IF-ADMIN", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SYS-010", "title": "Restrict admin session management to loopback", "level": "L1", "status": "Draft", "interface": "IF-ADMIN", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SYS-011", "title": "Survive service restart without session data loss", "level": "L1", "status": "Draft", "interface": "IF-HTTPS-API", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SUB-CTRL-001", "title": "Detect PERSON and ORG entities in input text", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-CTRL-002", "title": "Assign deterministic session-scoped placeholders", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-CTRL-003", "title": "Replace entity spans with placeholders in source text", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-CTRL-004", "title": "Report service health including vault connectivity", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-DAT-001", "title": "Persist mapping records atomically to SQLite vault", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-DAT-002", "title": "Initialise SQLite schema on first startup", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-DAT-003", "title": "Purge expired sessions and cascade-delete their mappings", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-SEC-001", "title": "Validate Bearer Token on all /v1/* requests", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-SEC-002", "title": "Enforce request payload size limit", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-SEC-003", "title": "Configure Caddy to terminate TLS and enforce minimum protocol version", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-SEC-004", "title": "Bind admin and health endpoints to loopback interface only", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-INT-001", "title": "CLI commands invoke library functions directly without HTTP", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-INT-002", "title": "CLI --json flag emits machine-readable output", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SYS-012", "title": "Reject oversized API request payloads", "level": "L1", "status": "Draft", "interface": "IF-HTTPS-API", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SYS-013", "title": "Provide streaming-compatible restore guidance via API", "level": "L1", "status": "Draft", "interface": "IF-HTTPS-API", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SYS-014", "title": "Honour per-request allowlist and denylist entity overrides", "level": "L1", "status": "Draft", "interface": "IF-HTTPS-API", "color": "#2980b9", "shape": "rect", "has_test": true}, {"id": "SUB-INT-003", "title": "Implement rolling-buffer restore for streamed chunks", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}, {"id": "SUB-CTRL-005", "title": "Apply allowlist and denylist filters before placeholder assignment", "level": "L2", "status": "Draft", "interface": "", "color": "#27ae60", "shape": "circle", "has_test": true}];
const links = [{"source": "SYS-001", "target": "SUB-CTRL-001"}, {"source": "SYS-001", "target": "SUB-CTRL-002"}, {"source": "SYS-001", "target": "SUB-DAT-001"}, {"source": "SYS-001", "target": "SUB-SEC-001"}, {"source": "SYS-002", "target": "SUB-CTRL-003"}, {"source": "SYS-002", "target": "SUB-DAT-001"}, {"source": "SYS-002", "target": "SUB-SEC-001"}, {"source": "SYS-003", "target": "SUB-SEC-001"}, {"source": "SYS-004", "target": "SUB-SEC-003"}, {"source": "SUB-DAT-004", "target": "SUB-DAT-001"}, {"source": "SUB-DAT-004", "target": "SUB-DAT-002"}, {"source": "SUB-DAT-005", "target": "SUB-DAT-002"}, {"source": "SUB-DAT-005", "target": "SUB-DAT-003"}, {"source": "SYS-007", "target": "SUB-CTRL-001"}, {"source": "SYS-007", "target": "SUB-CTRL-003"}, {"source": "SYS-007", "target": "SUB-INT-001"}, {"source": "SYS-007", "target": "SUB-INT-002"}, {"source": "SYS-008", "target": "SUB-INT-001"}, {"source": "SYS-008", "target": "SUB-DAT-003"}, {"source": "SYS-009", "target": "SUB-CTRL-004"}, {"source": "SYS-009", "target": "SUB-SEC-004"}, {"source": "SYS-010", "target": "SUB-SEC-004"}, {"source": "SYS-010", "target": "SUB-SEC-001"}, {"source": "SYS-011", "target": "SUB-DAT-004"}, {"source": "SYS-011", "target": "SUB-DAT-005"}, {"source": "SYS-012", "target": "SUB-SEC-002"}, {"source": "SYS-013", "target": "SUB-INT-003"}, {"source": "SYS-014", "target": "SUB-CTRL-005"}];
const orphans = new Set([]);
const childless = new Set([]);
const untested = new Set([]);
const brokenLinks = [];

// â”€â”€ Sidebar population â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nodeMap = {};
nodes.forEach(n => nodeMap[n.id] = n);

function fillList(listId, ids, emptyMsg) {
  const ul = document.getElementById(listId);
  if (!ids.length) {
    ul.innerHTML = `<li class="empty">${emptyMsg}</li>`;
    return;
  }
  ids.forEach(id => {
    const n = nodeMap[id] || {};
    ul.innerHTML += `<li>
      <span class="badge ${(n.level||'').toLowerCase()}">${n.level || '?'}</span>
      <strong>${id}</strong>
      <span>${n.title || ''}</span>
    </li>`;
  });
}

fillList("orphan-list", [...orphans], "None â€” all L2 requirements have parents âœ“");
fillList("childless-list", [...childless], "None â€” all L1 requirements have children âœ“");
fillList("untested-list", [...untested], "None â€” all requirements have test cases âœ“");

const bl = document.getElementById("broken-list");
if (!brokenLinks.length) {
  bl.innerHTML = '<li class="empty">No broken links âœ“</li>';
} else {
  brokenLinks.forEach(b => {
    bl.innerHTML += `<li><strong>${b.from}</strong> â†’ <span style="color:#e74c3c">${b.missing}</span> <span>(missing ${b.direction})</span></li>`;
  });
}

// Stats
const l1count = nodes.filter(n => n.level === "L1").length;
const l2count = nodes.filter(n => n.level === "L2").length;
const issueCount = orphans.size + childless.size + untested.size + brokenLinks.length;
document.getElementById("stats").innerHTML = `
  <div class="stat"><div class="v" style="color:#2980b9">${l1count}</div><div class="l">L1 Reqs</div></div>
  <div class="stat"><div class="v" style="color:#27ae60">${l2count}</div><div class="l">L2 Reqs</div></div>
  <div class="stat"><div class="v" style="color:${issueCount > 0 ? '#e74c3c' : '#27ae60'}">${issueCount}</div><div class="l">Issues</div></div>
`;

// â”€â”€ D3 Graph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const svg = d3.select("#graph");
const container = document.getElementById("graph");
const tooltip = document.getElementById("tooltip");

function getSize() {
  return { w: container.clientWidth, h: container.clientHeight };
}

let { w, h } = getSize();
svg.attr("width", w).attr("height", h);

const g = svg.append("g");

const simulation = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links).id(d => d.id).distance(120))
  .force("charge", d3.forceManyBody().strength(-400))
  .force("center", d3.forceCenter(w / 2, h / 2))
  .force("collision", d3.forceCollide(50));

// Arrow marker
svg.append("defs").append("marker")
  .attr("id", "arrow")
  .attr("viewBox", "0 -5 10 10")
  .attr("refX", 22)
  .attr("refY", 0)
  .attr("markerWidth", 6)
  .attr("markerHeight", 6)
  .attr("orient", "auto")
  .append("path")
  .attr("d", "M0,-5L10,0L0,5")
  .attr("fill", "#3a5a7a");

const link = g.append("g")
  .selectAll("line")
  .data(links)
  .join("line")
  .attr("stroke", "#2a3a52")
  .attr("stroke-width", 1.5)
  .attr("marker-end", "url(#arrow)");

const nodeGroup = g.append("g")
  .selectAll("g")
  .data(nodes)
  .join("g")
  .call(d3.drag()
    .on("start", (event, d) => { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
    .on("drag", (event, d) => { d.fx = event.x; d.fy = event.y; })
    .on("end", (event, d) => { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }))
  .on("mouseover", (event, d) => {
    const tc = d.has_test ? "Test: yes" : "Test: MISSING";
    const iface = d.level === "L1" && d.interface ? `Interface: ${d.interface}<br>` : "";
    let issues = [];
    if (orphans.has(d.id)) issues.push("Orphan (no parent)");
    if (childless.has(d.id)) issues.push("No children");
    if (!d.has_test) issues.push("Untested");
    tooltip.style.display = "block";
    tooltip.innerHTML = `<strong>${d.id}</strong><br><span style="color:#8a9bb0">${d.title}</span><br>${iface}${tc}<br>Status: ${d.status}${issues.length ? '<br>' + issues.join(' Â· ') : ''}`;
  })
  .on("mousemove", (event) => {
    tooltip.style.left = (event.pageX + 12) + "px";
    tooltip.style.top = (event.pageY - 10) + "px";
  })
  .on("mouseout", () => { tooltip.style.display = "none"; });

// Draw shapes: rect for L1, circle for L2
nodeGroup.each(function(d) {
  const el = d3.select(this);
  const isOrphan = orphans.has(d.id);
  const isChildless = childless.has(d.id);
  const isUntested = untested.has(d.id);
  const baseColor = isUntested ? "#7b1e1e" : (d.level === "L1" ? "#1d4e7e" : "#1a4731");
  const strokeColor = isOrphan ? "#e74c3c" : (isChildless ? "#e67e22" : (d.level === "L1" ? "#2980b9" : "#27ae60"));
  const strokeW = (isOrphan || isChildless) ? 2.5 : 1.5;

  if (d.level === "L1") {
    el.append("rect")
      .attr("width", 100).attr("height", 36)
      .attr("rx", 5).attr("ry", 5)
      .attr("x", -50).attr("y", -18)
      .attr("fill", baseColor)
      .attr("stroke", strokeColor)
      .attr("stroke-width", strokeW);
  } else {
    el.append("circle")
      .attr("r", 22)
      .attr("fill", baseColor)
      .attr("stroke", strokeColor)
      .attr("stroke-width", strokeW);
  }

  el.append("text")
    .attr("text-anchor", "middle")
    .attr("dy", "0.35em")
    .attr("fill", d.level === "L1" ? "#5dade2" : "#52be80")
    .attr("font-size", "10px")
    .attr("font-weight", "600")
    .text(d.id);
});

simulation.on("tick", () => {
  link
    .attr("x1", d => d.source.x)
    .attr("y1", d => d.source.y)
    .attr("x2", d => d.target.x)
    .attr("y2", d => d.target.y);
  nodeGroup.attr("transform", d => `translate(${d.x},${d.y})`);
});

// Zoom
svg.call(d3.zoom().on("zoom", (event) => { g.attr("transform", event.transform); }));

// Resize
window.addEventListener("resize", () => {
  const size = getSize();
  svg.attr("width", size.w).attr("height", size.h);
  simulation.force("center", d3.forceCenter(size.w / 2, size.h / 2)).alpha(0.3).restart();
});
</script>
</body>
</html>